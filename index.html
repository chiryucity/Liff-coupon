<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>クーポンアプリ</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: "Helvetica Neue", Arial, sans-serif;
      font-size: 18px;
      text-align: center;
      background-color: #f9f9f9;
      margin: 0;
      padding: 20px;
    }

    h1 {
      font-size: 28px;
      color: #333;
      margin-bottom: 30px;
    }

    p#status {
      font-size: 16px;
      color: #555;
      margin-bottom: 20px;
    }

    button {
      font-size: 22px;
      padding: 15px 40px;
      margin: 10px;
      border: none;
      border-radius: 10px;
      background-color: #00c300;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: #009900;
    }

    @media (max-width: 400px) {
      button {
        font-size: 20px;
        padding: 12px 30px;
      }
    }
  </style>
</head>
<body>
  <h1>クーポンアプリ</h1>

  <p id="status">読み込み中...</p>

  <button id="btn300">300円割引</button>
  <button id="btn600">600円割引</button>

  <script>
    const liffId = "2008732357-BnLZycLL"; // あなたのLIFF ID

    // LIFF初期化
    liff.init({ liffId: liffId })
      .then(() => {
        document.getElementById('status').innerText = 'LIFF動作確認OK';
      })
      .catch(err => {
        document.getElementById('status').innerText = 'LIFF初期化エラー: ' + err;
      });

    // kintone 連携関数
    function sendToKintone(userId, discount, storeId) {
      const appId = 893; // 履歴アプリ
      const apiToken = "jhXTFZz026tYU5EDRHEgVIzA48x5wu0OiL2OTkp2";

      const record = {
        "ユーザーID": { "value": userId },
        "割引額": { "value": discount },
        "店舗ID": { "value": storeId },
        "利用日時": { "value": new Date().toISOString() }
      };

      fetch(`https://chiryu.cybozu.com/k/v1/record.json`, {
        method: "POST",
        headers: {
          "X-Cybozu-API-Token": apiToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ app: appId, record: record })
      })
      .then(response => response.json())
      .then(data => {
        console.log("kintone履歴反映成功:", data);
        document.getElementById('status').innerText = `クーポン ${discount}円が履歴に反映されました`;
        alert(`クーポン ${discount}円が履歴に反映されました`);
        // 後で管理アプリ（892）に累積更新を追加可能
      })
      .catch(err => {
        console.error("kintone反映エラー:", err);
        document.getElementById('status').innerText = "kintone反映エラー";
        alert("kintone反映エラー。管理者に確認してください");
      });
    }

    // デバッグ用ボタン押下処理
    document.getElementById('btn300').addEventListener('click', () => {
      console.log("300円ボタン押下");
      document.getElementById('status').innerText = "300円ボタン押下";

      liff.getProfile()
        .then(profile => {
          console.log("ユーザーID:", profile.userId);
          document.getElementById('status').innerText = "ユーザーID取得: " + profile.userId;

          console.log("kintoneに送信するデータ:", {
            userId: profile.userId,
            discount: 300,
            storeId: "店舗A"
          });

          sendToKintone(profile.userId, 300, "店舗A");
        })
        .catch(err => {
          console.error("LIFFでユーザーID取得失敗:", err);
          document.getElementById('status').innerText = "ユーザーID取得失敗: " + err;
        });
    });

    document.getElementById('btn600').addEventListener('click', () => {
      console.log("600円ボタン押下");
      document.getElementById('status').innerText = "600円ボタン押下";

      liff.getProfile()
        .then(profile => {
          console.log("ユーザーID:", profile.userId);
          document.getElementById('status').innerText = "ユーザーID取得: " + profile.userId;

          console.log("kintoneに送信するデータ:", {
            userId: profile.userId,
            discount: 600,
            storeId: "店舗A"
          });

          sendToKintone(profile.userId, 600, "店舗A");
        })
        .catch(err => {
          console.error("LIFFでユーザーID取得失敗:", err);
          document.getElementById('status').innerText = "ユーザーID取得失敗: " + err;
        });
    });
  </script>
</body>
</html>
